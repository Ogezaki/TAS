<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
<title>TAS</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
<style>
:root{
  --brand:#8ecaff; --blue:#2196f3; --orange:#ff9800;
  --overlay:rgba(0,0,0,.82); --ov2:rgba(0,0,0,.55);
  --z:99999; --barH:56px;
  --safe-top:env(safe-area-inset-top,0px);
  --safe-bot:env(safe-area-inset-bottom,0px);
}
html,body{height:100%;margin:0;background:#000;color:#fff;font-family:system-ui,Arial;overscroll-behavior:none}
#titlebar{
  position:fixed;top:0;left:0;right:0;height:calc(var(--barH) + var(--safe-top));padding-top:var(--safe-top);
  display:flex;align-items:center;justify-content:center;
  background:#000;border-bottom:1px solid var(--brand);z-index:var(--z);font-weight:800
}
#titlebar .T{color:var(--orange)} #titlebar .S{color:var(--blue)}
.side{position:absolute;top:calc(8px + var(--safe-top));display:flex;gap:8px}
#left{left:10px} #right{right:10px}
.btnTop{
  border:2px solid var(--brand);border-radius:999px;background:var(--overlay);color:#fff;font-weight:700;
  padding:8px 12px;font-size:14px;box-shadow:0 6px 18px rgba(0,0,0,.25);cursor:pointer
}
#map{position:absolute;left:0;right:0;top:calc(var(--barH) + var(--safe-top));bottom:0;background:#111}
.pill{
  position:fixed;z-index:var(--z);background:var(--overlay);border:2px solid var(--brand);border-radius:12px;
  padding:6px 10px;font-weight:700
}
#speed{left:8px;top:calc(var(--barH) + var(--safe-top) + 8px)}
#chrono{left:50%;top:calc(var(--barH) + var(--safe-top) + 8px);transform:translateX(-50%);min-width:120px;text-align:center}
#pace {right:8px;top:calc(var(--barH) + var(--safe-top) + 8px)}
#dist {left:8px;top:calc(var(--barH) + var(--safe-top) + 48px)}
#fuel {right:8px;top:calc(var(--barH) + var(--safe-top) + 48px)}
.btn{
  border:2px solid var(--brand);border-radius:999px;background:var(--overlay);color:#fff;
  font-weight:800;padding:10px 14px;min-width:90px;cursor:pointer;text-align:center;
  box-shadow:0 6px 18px rgba(0,0,0,.25)
}
.btn:disabled,.btnTop:disabled{opacity:.45;filter:grayscale(.7);cursor:not-allowed}
#row{
  position:fixed;left:50%;transform:translateX(-50%);
  bottom:calc(12px + var(--safe-bot));z-index:var(--z);display:flex;gap:10px
}
#center{
  position:fixed;right:10px;top:calc(var(--barH) + var(--safe-top) + 106px);z-index:var(--z);
  width:44px;height:44px;border-radius:50%;border:2px solid var(--brand);
  background:var(--overlay);color:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center
}

/* Journal */
#lastTimes{
  position:fixed;left:50%;transform:translateX(-50%);
  bottom:calc(160px + var(--safe-bot));width:92vw;max-width:820px;z-index:var(--z);
  background:var(--overlay);color:#fff;border:2px solid var(--brand);border-radius:14px;display:none
}
#ltHead{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid var(--brand)}
#ltBody{max-height:45vh;overflow:auto}
.ltItem{padding:10px 12px;border-bottom:1px solid rgba(142,202,255,.35)}
.ltItem:last-child{border-bottom:none}
.ltTitle{font-weight:700}
.ltMeta{font-size:12px;color:#e6f2ff}
.ltActions{display:flex;gap:8px;margin-top:6px}
.chip{display:inline-block;padding:2px 8px;border-radius:999px;background:rgba(142,202,255,.15);border:1px solid var(--brand);font-size:12px;color:#fff}

/* Mini-cartes Leaflet */
.ltMap {
  width: 140px;
  height: 90px;
  border: 1px solid rgba(142,202,255,.35);
  border-radius: 8px;
  overflow: hidden;
  background: #0b0e12; /* fallback si tuiles non charg√©es */
}
.ltRow {
  display: grid;
  grid-template-columns: 150px 1fr;
  gap: 10px;
  align-items: center;
}

/* Modales */
.modal-backdrop{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:100000}
.modal{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);z-index:100001;width:min(92vw,520px);background:#101214;color:#fff;border:2px solid var(--brand);border-radius:12px}
.modal header{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid var(--brand)}
.modal .body{padding:12px}
.modal .actions{display:flex;gap:10px;justify-content:flex-end;padding:10px 12px;border-top:1px solid var(--brand)}
.field{display:flex;flex-direction:column;gap:6px;margin-bottom:12px}
.field input{padding:8px;border-radius:8px;border:1px solid #39424e;background:#0b0e12;color:#fff}
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:calc(80px + var(--safe-bot));z-index:100002;background:#0b0e12;border:1px solid var(--brand);color:#e6f2ff;border-radius:10px;padding:8px 12px;font-weight:700}
</style>
</head>
<body>
  <div id="titlebar">
    <div id="left" class="side"><button id="loginBtnTop" class="btnTop">Connexion</button></div>
    <div class="title"><span class="T">T</span>A<span class="S">S</span></div>
    <div id="right" class="side"><button id="settingsBtnTop" class="btnTop">R√©glages</button></div>
  </div>

  <div id="map" aria-label="map"></div>

  <div id="speed" class="pill">0.0 km/h</div>
  <div id="chrono" class="pill">00:00.0</div>
  <div id="pace"  class="pill">--:-- /km</div>
  <div id="dist"  class="pill">0.00 km</div>
  <div id="fuel"  class="pill">‚õΩ $0.00</div>

  <div id="row">
    <button id="start" class="btn">Start</button>
    <button id="lastBtn" class="btn">Rapport</button>
    <button id="stop"  class="btn" disabled>Stop</button>
  </div>
  <button id="center" title="Centrer">üìç</button>

  <div id="lastTimes">
    <div id="ltHead">
      <div><strong>Rapport journalier</strong> <span class="chip" id="ltUserChip"></span></div>
      <div style="display:flex;gap:8px"><button id="ltHistoricalBtn" class="btnTop">Consulter l'historique</button><button id="ltClose" class="btnTop">Fermer</button></div>
    </div>
    <div id="ltBody"><div class="ltItem">Aucun trajet enregistr√©.</div></div>
  </div>

  <!-- Modales -->
  <div id="modalBackdrop" class="modal-backdrop"></div>
  <div id="settingsModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="settingsTitle" style="display:none">
    <header><div id="settingsTitle">R√©glages</div><button class="btnTop" id="settingsClose">‚úï</button></header>
    <div class="body">
      <div class="field"><label for="athlete">Nom utilisateur :</label><input id="athlete" placeholder="user"/></div>
      <div class="field"><label for="centerIcon">Ic√¥ne mobile :</label><input id="centerIcon" placeholder="üìç"/></div>
      <div class="field"><label for="fuelConsumption">Consommation (L/100km) :</label><input id="fuelConsumption" type="number" placeholder="7.5" min="0" step="0.1"/></div>
      <div class="field"><label for="gasPrice">Prix essence ($/L) :</label><input id="gasPrice" type="number" placeholder="1.65" min="0" step="0.01"/></div>
      <small>Astuce : emoji (üìç, üéØ, ‚û§, ‚äï, üöÄ, ‚Ä¶)</small>
    </div>
    <div class="actions"><button class="btnTop" id="settingsSave">Enregistrer</button></div>
  </div>

  <div id="loginModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="loginTitle" style="display:none">
    <header><div id="loginTitle">Connexion</div><button class="btnTop" id="loginClose">‚úï</button></header>
    <div class="body">
      <div class="field"><label for="loginUser">Nom d'utilisateur :</label><input id="loginUser" placeholder="ex: Nathan" required/></div>
      <div class="field"><label for="loginPass">Mot de passe :</label><input id="loginPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required/></div>
      <small>Le compte est cr√©√© automatiquement √† la premi√®re connexion.</small>
    </div>
    <div class="actions"><button class="btnTop" id="loginAction">Se connecter</button></div>
  </div>

  <div id="toast" class="toast" style="display:none"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script>
  (function(){
    // ---- Utils ----
    const st=localStorage;
    const toast=(m)=>{const el=document.getElementById('toast'); el.textContent=m; el.style.display='block'; clearTimeout(window.__t); window.__t=setTimeout(()=>el.style.display='none',1600);};
    const fmtHMS=(ms)=>{const t=Math.max(0,Math.floor(ms)),h=Math.floor(t/3600000),m=Math.floor((t%3600000)/60000),s=Math.floor((t%60000)/1000),d=Math.floor((t%1000)/100);return h>0?`${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}.${d}`:`${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}.${d}`;};
    const hav=(a,b,c,d)=>{const R=6371000,t=Math.PI/180,dl=(c-a)*t,dn=(d-b)*t;const A=Math.sin(dl/2)**2+Math.cos(a*t)*Math.cos(c*t)*Math.sin(dn/2)**2;return 2*R*Math.asin(Math.sqrt(A));};
    const paceFmt=(kmh)=> kmh<=0 ? "--:-- /km" : ((m)=>`${String(Math.floor(m)).padStart(2,'0')}:${String(Math.round((m-Math.floor(m))*60)).padStart(2,'0')} /km`)(60/kmh);
    const todayISO=()=> (new Date()).toISOString().split('T')[0];

    // ---- Seuils d‚Äôun run valide (affichage) ----
    const MIN_VALID_MS = 60_000; // 1 min
    const MIN_VALID_M  = 100;    // 100 m

    // ---- Contraintes / auto-stop / anti-spike ----
    const AUTO_STOP_SEC=120, SPEED_LIMIT_KMH=10;
    const MAX_SPEED_KMH=300, MIN_DT_SEC=0.5;

    // ---- Login simple (localStorage) ----
    const loginBtnTop=document.getElementById('loginBtnTop'),
          loginModal=document.getElementById('loginModal'),
          loginUser=document.getElementById('loginUser'),
          loginPass=document.getElementById('loginPass'),
          loginAction=document.getElementById('loginAction'),
          loginClose=document.getElementById('loginClose');

    function userKey(u){return 'user:'+u.toLowerCase()}
    function currentUser(){return st.getItem('currentUser')}
    function saveUser(u,p){st.setItem(userKey(u), JSON.stringify({pass:p}))}
    function openModal(m){document.getElementById('modalBackdrop').style.display='block';m.style.display='block'}
    function closeModal(m){m.style.display='none';document.getElementById('modalBackdrop').style.display='none'}

    function updateLoginUI(){
      const u=currentUser();
      if(u){
        loginBtnTop.textContent='D√©connexion ('+u+')';
        loginBtnTop.onclick=()=>{st.removeItem('currentUser'); toast('D√©connect√© üëã'); updateLoginUI();};
        st.setItem('athlete',u);
      }else{
        loginBtnTop.textContent='Connexion';
        loginBtnTop.onclick=()=>openModal(loginModal);
      }
    }
    function login(u,p){
      const s=st.getItem(userKey(u));
      if(!s){ saveUser(u,p); st.setItem('currentUser',u); toast('Compte cr√©√© et connect√© ‚úÖ'); updateLoginUI(); closeModal(loginModal); return; }
      const obj=JSON.parse(s);
      if(obj.pass===p){ st.setItem('currentUser',u); toast('Connect√© ‚úÖ'); updateLoginUI(); closeModal(loginModal); }
      else toast('Mot de passe incorrect ‚ùå');
    }
    loginAction.onclick=()=>{const u=loginUser.value.trim(),p=loginPass.value.trim(); if(!u||!p) return toast('Champs requis ‚ö†Ô∏è'); login(u,p);};
    loginClose.onclick=()=>closeModal(loginModal);
    document.getElementById('modalBackdrop').onclick=()=>[loginModal, settingsModal].forEach(m=>{ if(m.style.display==='block') closeModal(m); });

    // ---- R√©glages ----
    const settingsModal=document.getElementById('settingsModal'),
          settingsBtnTop=document.getElementById('settingsBtnTop'),
          settingsClose=document.getElementById('settingsClose'),
          settingsSave=document.getElementById('settingsSave'),
          athleteInp=document.getElementById('athlete'),
          centerIconInp=document.getElementById('centerIcon'),
          fuelConsumptionInp=document.getElementById('fuelConsumption'),
          gasPriceInp=document.getElementById('gasPrice');
    if(!st.getItem('athlete')) st.setItem('athlete','user');
    if(!st.getItem('centerIcon')) st.setItem('centerIcon','üìç');
    if(!st.getItem('fuelConsumption')) st.setItem('fuelConsumption','7.5');
    if(!st.getItem('gasPrice')) st.setItem('gasPrice','1.65');
    athleteInp.value=st.getItem('athlete'); 
    centerIconInp.value=st.getItem('centerIcon');
    fuelConsumptionInp.value=st.getItem('fuelConsumption');
    gasPriceInp.value=st.getItem('gasPrice');
    settingsBtnTop.onclick=()=>openModal(settingsModal);
    settingsClose.onclick=()=>closeModal(settingsModal);
    settingsSave.onclick=()=>{ 
      const a=(athleteInp.value||'user').trim(); 
      st.setItem('athlete',a); 
      const ic=(centerIconInp.value||'üìç').trim()||'üìç'; 
      st.setItem('centerIcon',ic);
      const fc=(fuelConsumptionInp.value||'7.5').trim();
      st.setItem('fuelConsumption',fc);
      const gp=(gasPriceInp.value||'1.65').trim();
      st.setItem('gasPrice',gp);
      if(meMarker){ const userIcon=L.divIcon({html:`<div style="font-size:24px;">${ic}</div>`,className:'userIcon',iconSize:[30,30],iconAnchor:[15,15]}); meMarker.setIcon(userIcon); } 
      closeModal(settingsModal); 
      toast('R√©glages enregistr√©s'); 
    };

    // ---- Carte ----
    const map=L.map('map',{zoomControl:false,attributionControl:false});
    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);
    map.setView([48.8584,2.2945],13); // fallback
    setTimeout(()=>map.invalidateSize(),80);

    // ---- Trac√© live ----
    const liveTrail=L.polyline([], {color:'#3388ff',weight:4,opacity:0.9}).addTo(map);

    // ---- UI refs ----
    const speedEl=document.getElementById('speed'),
          chronoEl=document.getElementById('chrono'),
          paceEl=document.getElementById('pace'),
          distEl=document.getElementById('dist'),
          fuelEl=document.getElementById('fuel'),
          startBtn=document.getElementById('start'),
          stopBtn=document.getElementById('stop');

    // ---- √âtat ----
    let meMarker=null, firstCentered=false;
    let totalDistM=0,lastFix=null,lastFixTime=null,trace=[];
    let lastSpeedKmh=0,maxSpeedKmh=0;
    let chronoStart=null,chronoTimer=null,running=false,idleStartMs=null;
    let watchId=null;

    // ---- Chrono ----
    function startTimer(){ if(chronoTimer) return; chronoStart=Date.now(); chronoEl.textContent='00:00.0'; chronoTimer=setInterval(()=>{ const el=Date.now()-chronoStart; chronoEl.textContent=fmtHMS(el); const avgKmh=el>0?(totalDistM/(el/1000))*3.6:0; paceEl.textContent=paceFmt(avgKmh); }, 200); }
    function stopTimer(){ if(chronoTimer){ clearInterval(chronoTimer); chronoTimer=null; } }

    // ---- Mise √† jour co√ªt essence (toutes les 10 sec) ----
    let fuelUpdateTimer=null;
    function updateFuelCost(){
      const fuelConsumption = parseFloat(st.getItem('fuelConsumption') || '7.5');
      const gasPrice = parseFloat(st.getItem('gasPrice') || '1.65');
      const distKm = totalDistM / 1000;
      const fuelLitersUsed = (distKm * fuelConsumption) / 100;
      const fuelCostCAD = fuelLitersUsed * gasPrice;
      fuelEl.textContent = `‚õΩ $${fuelCostCAD.toFixed(2)}`;
    }
    function startFuelTimer(){
      if(fuelUpdateTimer) clearInterval(fuelUpdateTimer);
      updateFuelCost();
      fuelUpdateTimer = setInterval(updateFuelCost, 10000); // Update toutes les 10 sec
    }
    function stopFuelTimer(){
      if(fuelUpdateTimer){ clearInterval(fuelUpdateTimer); fuelUpdateTimer=null; }
      updateFuelCost(); // Update final
    }

    // ---- Geoloc ----
    function onFix(lat,lon){
      // marker + centrage
      if(!meMarker){
        const ic = st.getItem('centerIcon') || 'üìç';
        const userIcon=L.divIcon({html:`<div style="font-size:24px;">${ic}</div>`,className:'userIcon',iconSize:[30,30],iconAnchor:[15,15]});
        meMarker=L.marker([lat,lon],{icon:userIcon}).addTo(map);
      }else meMarker.setLatLng([lat,lon]);
      if(!firstCentered){ firstCentered=true; map.setView([lat,lon],17); } else { map.panTo([lat,lon],{animate:true}); }

      // distance / vitesse avec anti-spike
      const now=Date.now();
      if(lastFix){
        const dt=Math.max(MIN_DT_SEC, (now-(lastFixTime||now))/1000);
        const dM=hav(lastFix.lat,lastFix.lon,lat,lon);
        const vKmh=(dM/dt)*3.6;
        if(vKmh<=MAX_SPEED_KMH){
          totalDistM+=dM; lastSpeedKmh=vKmh; if(vKmh>maxSpeedKmh) maxSpeedKmh=vKmh;
          if(running){ liveTrail.addLatLng([lat,lon]); trace.push({lat,lon,t:now}); }
        }
      } else {
        if(running){ liveTrail.addLatLng([lat,lon]); trace.push({lat,lon,t:now}); }
      }
      lastFix={lat,lon}; lastFixTime=now;

      // UI live
      speedEl.textContent=`${lastSpeedKmh.toFixed(1)} km/h`;
      distEl.textContent =(totalDistM/1000).toFixed(2)+' km';
      if(running){
        const elapsed=Date.now()-chronoStart;
        const avgKmh = elapsed>0 ? (totalDistM/(elapsed/1000))*3.6 : 0;
        paceEl.textContent = paceFmt(avgKmh);

        // auto-stop si lent prolong√©
        if(lastSpeedKmh<=SPEED_LIMIT_KMH){
          if(idleStartMs===null) idleStartMs=now;
          if((now-idleStartMs)/1000 >= AUTO_STOP_SEC){ stopRun(true); toast('Auto-enregistrement (arr√™t prolong√©)'); }
        } else idleStartMs=null;
      }

      // heartbeat (optionnel)
      fetch('/api/heartbeat',{
        method:'POST',headers:{'Content-Type':'application/json'},
        body: JSON.stringify({athlete:st.getItem('athlete')||'',session_id:'',lat,lon})
      }).catch(()=>{});
    }

    function startWatch(){
      if(!navigator.geolocation){ alert('G√©oloc non support√©e'); return; }
      watchId = navigator.geolocation.watchPosition(
        p => {const c=p.coords; onFix(c.latitude,c.longitude);},
        e => { console.error(e); alert('Active la g√©oloc et utilise HTTPS (ou http://localhost).'); },
        { enableHighAccuracy:true, maximumAge:2000, timeout:10000 }
      );
    }
    function stopWatch(){ if(watchId!==null){ navigator.geolocation.clearWatch(watchId); watchId=null; } }

    // ---- Historique par utilisateur ----
    function runsKey(){ const u=currentUser()||st.getItem('athlete')||'user'; return 'runs:'+u; }
    function getRuns(){ return JSON.parse(st.getItem(runsKey())||'[]'); }
    function setRuns(a){ st.setItem(runsKey(), JSON.stringify(a)); }
    function currentUser(){ return st.getItem('currentUser'); }

    async function saveRun(auto=false){
      const athlete=currentUser()||st.getItem('athlete')||'user';
      const startISO=new Date(chronoStart||Date.now()).toISOString();
      const elapsed=chronoStart?(Date.now()-chronoStart):0;
      const distM=Math.round(totalDistM);
      const avgK=elapsed>0?(distM/(elapsed/1000))*3.6:0;
      
      // Calcul consommation essence
      const fuelConsumption = parseFloat(st.getItem('fuelConsumption') || '7.5');
      const gasPrice = parseFloat(st.getItem('gasPrice') || '1.65');
      const distKm = distM / 1000;
      const fuelLitersUsed = (distKm * fuelConsumption) / 100;
      const fuelCostCAD = fuelLitersUsed * gasPrice;

      const payload={
        athlete,
        start_time_iso:startISO,
        end_time_iso:new Date().toISOString(),
        elapsed_ms:elapsed,
        distance_m:distM,
        avg_kmh:Number(avgK.toFixed(2)),
        max_kmh:Number(maxSpeedKmh.toFixed(2)),
        pace_min_km: paceFmt(avgK),
        fuel_liters_used:Number(fuelLitersUsed.toFixed(2)),
        fuel_cost_cad:Number(fuelCostCAD.toFixed(2)),
        trace
      };

      // local
      const arr=getRuns(); arr.unshift(payload); setRuns(arr);

      // serveur (best-effort)
      try{
        await fetch('/api/save_free_run',{
          method:'POST',headers:{'Content-Type':'application/json'},
          body: JSON.stringify({
            athlete, session_id: athlete+'-'+startISO,
            elapsed_ms: elapsed, elapsed_hms: fmtHMS(elapsed),
            buffer_m: 0, trace, distance_m: distM,
            avg_kmh: payload.avg_kmh, max_kmh: payload.max_kmh,
            pace_min_km: payload.pace_min_km
          })
        });
      }catch(_e){}

      renderLastTimes();
      toast((auto?'Auto-enregistr√©':'Enregistr√©')+' ‚úì');
    }

    // ---- UI √©tat ----
    function setIdle(){ startBtn.disabled=false; stopBtn.disabled=true; }
    function setRun(){  startBtn.disabled=true;  stopBtn.disabled=false; }

    // ---- Start/Stop ----
    function startRun(){
      if(running) return;
      running=true;
      totalDistM=0; lastFix=null; lastFixTime=null; trace=[];
      lastSpeedKmh=0; maxSpeedKmh=0; idleStartMs=null;
      liveTrail.setLatLngs([]);
      setRun(); startTimer(); startFuelTimer(); startWatch();
      if(navigator.geolocation){ navigator.geolocation.getCurrentPosition(p=>{onFix(p.coords.latitude,p.coords.longitude);}); }
      toast('Go!');
    }
    async function stopRun(auto=false){
      if(!running) return;
      running=false;
      stopWatch(); stopTimer(); stopFuelTimer(); setIdle();
      await saveRun(auto);
    }

    // Bind (√©vite doublons)
    if (window.__tasBound!==true) {
      startBtn.addEventListener('click', startRun);
      stopBtn .addEventListener('click', ()=>stopRun(false));
      window.__tasBound = true;
    }
    document.getElementById('center').onclick=()=>{ if(meMarker) map.setView(meMarker.getLatLng(),17); };

    // ---- Rapport journalier avec mini-cartes Leaflet ----
    const lastTimes=document.getElementById('lastTimes'),
          ltBody=document.getElementById('ltBody'),
          ltUserChip=document.getElementById('ltUserChip');

    function invalidateAllMiniMaps(){
      (window.__miniMaps || []).forEach(m => { try{ m.invalidateSize(); }catch(_){} });
    }

    function renderLastTimes(){
      const all = getRuns();
      const todayList = all.filter(r => (r.start_time_iso || '').startsWith(todayISO()));
      // Filtre de validit√© (‚â• 1 min ET > 100 m)
      const list = todayList.filter(r => (r.elapsed_ms || 0) >= MIN_VALID_MS && (r.distance_m || 0) > MIN_VALID_M);

      const user=currentUser()||st.getItem('athlete')||'Invit√©';
      ltUserChip.textContent=user;

      if(!list.length){
        ltBody.innerHTML='<div class="ltItem">Aucun trajet <em>valide</em> aujourd‚Äôhui (‚â• 1 min et &gt; 100 m).</div>';
        window.__miniMaps = [];
        return;
      }

      // (Option perf) limiter √† N plus r√©cents
      // const MAX_THUMBS = 8;
      // const shown = list.slice(0, MAX_THUMBS);
      const shown = list;

      // 1) HTML lignes
      ltBody.innerHTML = shown.map((r,i)=>{
        const d=new Date(r.start_time_iso);
        const start=d.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
        const dur=fmtHMS(r.elapsed_ms||0);
        const dist=(r.distance_m/1000).toFixed(2)+' km';
        const fuel = r.fuel_liters_used ? r.fuel_liters_used.toFixed(2)+' L' : '‚Äî L';
        const cost = r.fuel_cost_cad ? '$'+r.fuel_cost_cad.toFixed(2) : '‚Äî';
        return `
          <div class="ltItem ltRow" data-i="${i}">
            <div><div class="ltMap" id="ltmap-${i}"></div></div>
            <div>
              <div class="ltTitle">D√©part ${start} ‚Äî ${dist}</div>
              <div class="ltMeta">Dur√©e ${dur} | Essence ${fuel} (${cost})</div>
              <div class="ltActions"><button class="btnTop" data-act="details">D√©tails</button></div>
            </div>
          </div>`;
      }).join('');

      // 2) Mini-cartes
      window.__miniMaps = [];
      shown.forEach((r, i) => {
        const el = document.getElementById(`ltmap-${i}`);
        if (!el || !r.trace || r.trace.length < 2) return;

        const mm = L.map(el, {
          zoomControl: false,
          attributionControl: false,
          dragging: false,
          scrollWheelZoom: false,
          doubleClickZoom: false,
          boxZoom: false,
          keyboard: false,
          tap: false,
          touchZoom: false,
          preferCanvas: true
        });
        window.__miniMaps.push(mm);

        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(mm);

        const latlngs = r.trace.map(p => [p.lat, p.lon]);
        const poly = L.polyline(latlngs, { color: '#2196f3', weight: 3, opacity: 0.95 }).addTo(mm);

        try { mm.fitBounds(poly.getBounds(), { padding: [8, 8] }); } catch(_) {}

        const s = latlngs[0], e = latlngs[latlngs.length - 1];
        if (s) L.circleMarker(s, { radius: 4, color: '#00e676', fillOpacity: 0.9 }).addTo(mm);
        if (e) L.circleMarker(e, { radius: 4, color: '#ff5252', fillOpacity: 0.9 }).addTo(mm);

        // sizing de s√©curit√©
        setTimeout(() => { try{ mm.invalidateSize(); }catch(_){} }, 50);
      });

      // 3) Boutons d√©tails
      ltBody.querySelectorAll('[data-act="details"]').forEach(btn=>{
        btn.onclick=()=>{
          const idx=Number(btn.closest('.ltItem').dataset.i);
          const run=shown[idx];
          if(run){ try{ st.setItem('lastViewedRun', JSON.stringify(run)); location.assign('/details'); }catch(e){ alert("Impossible d‚Äôouvrir la page d√©tails."); } }
        };
      });
    }

    // ---- Historique complet (redirige vers la page details) ----
    document.getElementById('ltHistoricalBtn').onclick = ()=>{
      try {
        st.setItem('viewHistoricalMode', 'true');
        location.assign('/details');
      } catch(e) {
        alert("Impossible d'ouvrir l'historique.");
      }
    };

    function openLastTimes(){
      lastTimes.style.display = 'block';          // montrer d'abord
      requestAnimationFrame(() => {
        renderLastTimes();                        // construire quand visible
        setTimeout(invalidateAllMiniMaps, 60);    // forcer la taille
      });
    }
    function closeLastTimes(){ lastTimes.style.display='none'; }
    document.getElementById('lastBtn').onclick=()=>{ (lastTimes.style.display==='block') ? closeLastTimes() : openLastTimes(); };
    document.getElementById('ltClose').onclick=closeLastTimes;

    // Invalidation aussi sur resize/scroll
    window.addEventListener('resize', () => setTimeout(invalidateAllMiniMaps, 60));
    document.getElementById('ltBody').addEventListener('scroll', () => setTimeout(invalidateAllMiniMaps, 0));

    // ---- Boot ----
    function initUI(){ 
      setIdle(); 
      updateLoginUI(); 
      if(navigator.geolocation){ navigator.geolocation.getCurrentPosition(p=>onFix(p.coords.latitude,p.coords.longitude)); }
      
      // Charger les prix d'essence √† l'initialisation
      fetch('/api/gas-price-by-coords/0/0')
        .then(r => r.json())
        .then(data => {
          if(data.price && data.price !== 'None') {
            const priceStr = String(data.price).replace('$', '').replace('CAD', '').trim();
            const price = parseFloat(priceStr);
            if(!isNaN(price)) {
              st.setItem('gasPrice', price.toFixed(2));
              document.getElementById('gasPrice').value = price.toFixed(2);
              log(`[GAS] Auto-detected price: $${price.toFixed(2)}/L from ${data.detected_region}`);
            }
          }
        })
        .catch(e => console.log('[GAS] Could not auto-detect price:', e));
    }
    initUI();
  })();
  </script>
</body>
</html>
